# Настройка Reverse Proxy на Synology DSM

Инструкция по настройке reverse proxy на Synology NAS для проксирования запросов на внутренний сервер с Django.

## Предварительные требования

- Synology NAS с установленным DSM
- Внутренний сервер с Django Admin, доступный из локальной сети
- Домен, указывающий на внешний IP адрес (или IP адрес Synology)

## Настройка через веб-интерфейс Synology DSM

### Шаг 1: Установка пакета Reverse Proxy

1. Откройте **Центр пакетов** (Package Center)
2. Найдите и установите **Web Station** (если еще не установлен)
3. Reverse Proxy доступен в настройках DSM

### Шаг 2: Настройка Reverse Proxy

1. Откройте **Панель управления** (Control Panel)
2. Перейдите в **Логин-портал** (Login Portal) или **Сеть** (Network) → **Обратный прокси-сервер** (Reverse Proxy)
3. Нажмите **Создать** (Create)

### Шаг 3: Настройка правил Reverse Proxy

#### Основное правило (для админки Django)

**Описание:** Santa Game Django Admin

**Источник:**
- **Описание:** Santa Game Admin
- **Протокол:** HTTPS
- **Имя узла:** `santa.p7net.ru` (ваш домен)
- **Порт:** `443`
- **HSTS:** Включено (рекомендуется)

**Назначение:**
- **Протокол:** HTTP
- **Имя узла:** `192.168.1.100` (внутренний IP сервера с Django)
- **Порт:** `8000` (порт Django Admin)

**Дополнительные настройки:**
- **Включить WebSocket:** Да (если используется)
- **Включить сжатие:** Да
- **Настроить заголовки:**
  - `X-Forwarded-Proto: https`
  - `X-Forwarded-Host: $host`
  - `X-Real-IP: $remote_addr`

#### Дополнительное правило для статических файлов (опционально)

Если хотите обслуживать статические файлы напрямую через Synology:

**Источник:**
- **Протокол:** HTTPS
- **Имя узла:** `santa.p7net.ru`
- **Путь:** `/static/`
- **Порт:** `443`

**Назначение:**
- **Протокол:** HTTP
- **Имя узла:** `192.168.1.100`
- **Путь:** `/static/`
- **Порт:** `8000`

**Примечание:** В большинстве случаев достаточно одного правила для всех запросов, включая `/static/`. Synology автоматически проксирует все запросы на внутренний сервер.

### Шаг 4: Настройка SSL сертификата

1. В **Панели управления** → **Безопасность** (Security) → **Сертификат** (Certificate)
2. Добавьте сертификат для вашего домена:
   - Используйте Let's Encrypt (автоматическое обновление)
   - Или загрузите свой сертификат
3. Назначьте сертификат для reverse proxy правила

### Шаг 5: Настройка Firewall (если используется)

Убедитесь, что в настройках Firewall Synology разрешены входящие подключения:
- Порт 443 (HTTPS) - для reverse proxy
- Порт 80 (HTTP) - для редиректа на HTTPS (опционально)

## Альтернативная настройка через конфигурационные файлы

Если у вас установлен Nginx на Synology (через Docker или вручную), можно использовать конфигурацию из `nginx-santa-game-admin-external.conf.example`, адаптировав пути и настройки под Synology.

### Расположение конфигурационных файлов Nginx на Synology

Обычно конфигурация находится в:
- `/usr/syno/share/nginx/` - для встроенного веб-сервера
- `/etc/nginx/` - если установлен Nginx вручную

**Внимание:** Изменение системных файлов Synology может быть перезаписано при обновлении DSM. Используйте веб-интерфейс, когда это возможно.

## Проверка работы

1. Откройте в браузере: `https://santa.p7net.ru/admin/`
2. Проверьте, что статические файлы загружаются (откройте DevTools → Network)
3. Проверьте логи на внутреннем сервере Django

## Решение проблем

### Статические файлы не загружаются

1. Убедитесь, что на внутреннем сервере выполнено:
   ```bash
   python manage.py collectstatic --noinput
   ```

2. Проверьте, что Django слушает на `0.0.0.0:8000` (не только `127.0.0.1`)

3. Проверьте firewall на внутреннем сервере:
   ```bash
   # Разрешить подключения с Synology
   sudo ufw allow from 192.168.1.X to any port 8000
   ```

### Ошибка 502 Bad Gateway

1. Проверьте доступность внутреннего сервера с Synology:
   ```bash
   # На Synology через SSH
   curl http://192.168.1.100:8000/admin/
   ```

2. Проверьте, что Django Admin запущен на внутреннем сервере:
   ```bash
   sudo systemctl status santa-game-admin.service
   ```

3. Проверьте логи на внутреннем сервере:
   ```bash
   sudo journalctl -u santa-game-admin.service -n 50
   ```

### Ошибка CSRF

Убедитесь, что в `settings.py` на внутреннем сервере настроено:
```python
CSRF_TRUSTED_ORIGINS = ['https://santa.p7net.ru']
SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
```

## Дополнительные настройки

### Кеширование статических файлов

В настройках reverse proxy в Synology можно включить кеширование для улучшения производительности.

### Мониторинг

Используйте логи Synology для мониторинга:
- **Центр журналов** (Log Center) → **Веб-доступ** (Web Access)
- Фильтруйте по вашему домену для отслеживания запросов

## Автор

Michael BAG  
Telegram: @michaelbag  
E-mail: mk@remark.pro

